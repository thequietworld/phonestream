<!DOCTYPE html>
<html>
<head>
  <title>iPhone Live Stream</title>
</head>
<body>
  <h1>Live Stream</h1>
  <video id="camera" autoplay playsinline width="320"></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <img id="latest" src="latest.jpg" width="320" />

  <button id="startBtn">Start Streaming</button>

  <script>
    const video = document.getElementById('camera');
    const canvas = document.getElementById('canvas');
    const startBtn = document.getElementById('startBtn');
    const latestImg = document.getElementById('latest');

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (err) {
        console.error('Error accessing camera:', err);
      }
    }

    async function uploadFrame() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);

      canvas.toBlob(async (blob) => {
        if (!blob) return;
        const formData = new FormData();
        formData.append('image', blob, 'frame.jpg');

        try {
          await fetch('/upload', { method: 'POST', body: formData });
        } catch (err) {
          console.error('Upload failed:', err);
        }
      }, 'image/jpeg');
    }

    startBtn.onclick = () => {
      startCamera();
      setInterval(uploadFrame, 10000); // upload every 10 seconds
    };

    // Auto-refresh latest image every 10s
    setInterval(() => {
      latestImg.src = 'latest.jpg?time=' + new Date().getTime();
    }, 10000);
  </script>
</body>
</html>
